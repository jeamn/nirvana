<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
      【Node】如何实现一个require方法 | Nirvana
    </title>
    <meta name="description" content="A VitePress site">
    <link rel="stylesheet" href="/nirvana/_assets/style.b16d0605.css">
    <link rel="modulepreload" href="/nirvana/_assets/common-874b6af4.js">
    <link rel="modulepreload" href="/nirvana/_assets/docs_node_realize-require.md.3830c2f9.lean.js">
    <link rel="modulepreload" href="/nirvana/_assets/app.963d3ba1.js">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="keywords" content="Jeamn">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://lib.baomitu.com/gitalk/1.7.0/gitalk.min.css">
    <script src="https://lib.baomitu.com/gitalk/1.7.0/gitalk.min.js"></script>
    <script src="https://lib.baomitu.com/axios/0.21.1/axios.js"></script>
    
  </head>
  <body>
    <div id="app"><!--[--><div id="containerColor" class="no-sidebar theme" data-v-4a5ae416><header class="navbar" data-v-4a5ae416><!--[--><a class="title" aria-label="Nirvana, back to home" href="/nirvana/"><img class="logo" src="/nirvana/favicon.ico" alt="logo"><span>Nirvana</span></a><div class="flex-grow"></div><nav class="nav-links hide-mobile"><!--[--><!--[--><div class="nav-item"><a class="nav-link" href="/nirvana/index.html" target="" rel="">🏠 首页 <!-- <OutboundLink v-if="isExternalLink" /> --></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/nirvana/more/docs.html" target="" rel="">📅 归档 <!-- <OutboundLink v-if="isExternalLink" /> --></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/nirvana/more/tags.html" target="" rel="">📂 分类 <!-- <OutboundLink v-if="isExternalLink" /> --></a></div><!--]--><!--]--><!----><!----></nav><!--[--><!--]--><!--]--><div class="sidebar-button" data-v-4a5ae416><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div></header><aside class="" data-v-4a5ae416><!--[--><nav class="nav-links show-mobile"><!--[--><!--[--><div class="nav-item"><a class="nav-link" href="/nirvana/index.html" target="" rel="">🏠 首页 <!-- <OutboundLink v-if="isExternalLink" /> --></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/nirvana/more/docs.html" target="" rel="">📅 归档 <!-- <OutboundLink v-if="isExternalLink" /> --></a></div><!--]--><!--[--><div class="nav-item"><a class="nav-link" href="/nirvana/more/tags.html" target="" rel="">📂 分类 <!-- <OutboundLink v-if="isExternalLink" /> --></a></div><!--]--><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar"><!--[--><!--]--></ul><!--[--><!--]--><!--]--></aside><!----><!-- TODO: make this button accessible --><div class="sidebar-mask" data-v-4a5ae416></div><main data-v-4a5ae416><!--[--><div class="content"><!--[--><!--]--><div class="md-header"><div class="md-title">【Node】如何实现一个require方法</div><span id="jinrishici-sentence">正在加载今日诗词....</span><div class="md-date">2019-02-02T00:00:00.000Z</div></div><ul class="catalog"><!--[--><li class="catalog-item"><!----><a class="level level-3" href="#一、node中requrie的用法">一、node中requrie的用法</a></li><li class="catalog-item"><!----><a class="level level-3" href="#二、实现require需要实现什么">二、实现require需要实现什么</a></li><!--]--></ul><div><h3 id="一、node中requrie的用法"><a class="header-anchor" href="#一、node中requrie的用法" aria-hidden="true">#</a> 一、node中requrie的用法</h3><p>我们知道，node的模块化实现用的是CommonJS规范，即，引入模块使用的是：</p><div class="language-js"><pre><code><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>&#39;<span class="token punctuation">.</span><span class="token operator">/</span>name<span class="token punctuation">.</span>js<span class="token punctuation">)</span>
</code></pre></div><p>导出模块使用的是：</p><div class="language-js"><pre><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre></div><p>如果我们导入的文件没有写后缀名，那么node默认会先寻找路径下.js结尾的文件，如果找不到，会继续找.json结尾的文件，如果找不到，会找node结尾的文件....</p><p>那么我们来看一下怎么实现require方法，简单的实现，不考虑复杂因素，所以我们会默认给出导入模块的后缀名，.js或者.json，来对应处理引入的模块内容并将其导出。 <!-- more --></p><h3 id="二、实现require需要实现什么"><a class="header-anchor" href="#二、实现require需要实现什么" aria-hidden="true">#</a> 二、实现require需要实现什么</h3><p>接下来我们先考虑实现一个require的大致思路：</p><ul><li>1） 拿到我们传入require方法的这个路径，在这里我们要拿绝对路径</li><li>2） 创建一个模块，并将我们拿到的模块内容存起来</li><li>3） 根据后缀名称来决定如何导出模块的内容</li></ul><h4 id="第一步：拿路径"><a class="header-anchor" href="#第一步：拿路径" aria-hidden="true">#</a> 第一步：拿路径</h4><div class="language-js"><pre><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">req</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 拿到绝对路径</span>
    <span class="token keyword">const</span> absPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="第二步：存内容"><a class="header-anchor" href="#第二步：存内容" aria-hidden="true">#</a> 第二步：存内容</h4><div class="language-js"><pre><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span>

<span class="token comment">//存储内容我们需要定义一个模块，模块只包含这个模块的路径id，以及模块的内容</span>
<span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id
    <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token comment">//默认导出一个空对象</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">req</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 拿到绝对路径</span>
    <span class="token keyword">let</span> absPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span>
    <span class="token comment">// 创建一个模块来存储内容</span>
    <span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>absPath<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="第三步：导出去"><a class="header-anchor" href="#第三步：导出去" aria-hidden="true">#</a> 第三步：导出去</h4><blockquote><p>json文件：直接导出模块的内容</p><p>js文件：用闭包来处理导出的js模块，node的require是这样实现的，这样能解决命名空间的问题</p></blockquote><div class="language-js"><pre><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;vm&#39;</span><span class="token punctuation">)</span> <span class="token comment">// node用一个虚拟的沙箱来实现代码的执行，而不是通过eval，因为eval不安全，eval可以读到全局的变量</span>

<span class="token comment">//存储内容我们需要定义一个模块，模块只包含这个模块的路径id，以及模块的内容</span>
<span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id
    <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token comment">//默认导出一个空对象</span>
<span class="token punctuation">}</span>

<span class="token comment">//自定义一个对象来实现对应后缀文件的执行方式</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&#39;.js&#39;</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">)</span>
        <span class="token comment">//每个模块都是一个闭包，这个闭包默认有五个参数：</span>
        <span class="token keyword">let</span> moduleWrap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;(function(exports, module, require, __dirname, __filename){&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;})&#39;</span><span class="token punctuation">]</span>
        <span class="token comment">//将读出来的内容拼接成代码块并在沙箱中执行</span>
        <span class="token keyword">let</span> script <span class="token operator">=</span> moduleWrap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> content <span class="token operator">+</span> moduleWrap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&#39;.json&#39;</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//如果是json结尾，直接将内容导出</span>
        module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">req</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 拿到绝对路径</span>
    <span class="token keyword">let</span> absPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span>
    <span class="token comment">// 创建一个模块来存储内容</span>
    <span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>absPath<span class="token punctuation">)</span>
    <span class="token comment">// 获取后缀名</span>
    <span class="token keyword">let</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>absPath<span class="token punctuation">)</span>
    <span class="token comment">// 根据后缀名称进行加载</span>
    obj<span class="token punctuation">[</span>ext<span class="token punctuation">]</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>
    <span class="token comment">//最后将modele的exports返回</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports
<span class="token punctuation">}</span>

<span class="token comment">//并试验一下</span>
<span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token function">req</span><span class="token punctuation">(</span><span class="token string">&#39;./user.json&#39;</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> name2 <span class="token operator">=</span> <span class="token function">req</span><span class="token punctuation">(</span><span class="token string">&#39;./name.js&#39;</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>简单而又粗暴的实现。。。</p><h5 id="参考文章"><a class="header-anchor" href="#参考文章" aria-hidden="true">#</a> 参考文章</h5><p><a href="https://juejin.im/post/5ab4d3d151882521d6578298" target="_blank" rel="noopener noreferrer">Node.js Require源码粗读</a><a href="http://www.ruanyifeng.com/blog/2015/05/require.html" target="_blank" rel="noopener noreferrer">阮一峰 require() 源码解读</a></p></div><div class="links-wrapper"><div class="prev-link"><!----></div><div class="next-link"><!----></div></div><div><p class="platform"> Copyright © 2022-2023 <a href="https://github.com/jeamn">@Jeamn</a></p></div><!--[--><!--]--></div><!-- 只想点击背景才关闭 请使用 .self 修饰符 --><div style="display:none;" class="imgBox"><img src=""></div><!--]--></main><div class="theme-select" data-v-4a5ae416><ul data-v-4a5ae416><li class="active" data-v-4a5ae416>☀️</li><li class="" data-v-4a5ae416>🌑</li></ul></div></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"README.md\":\"74ba73cf\",\"index.md\":\"c2842757\",\"more_Friendship.md\":\"2ddbc272\",\"more_docs.md\":\"ac4de4a9\",\"more_index.md\":\"2f258ce2\",\"more_tags.md\":\"9c361e7d\",\"docs_algorithm_monotonic-stack.md\":\"06425485\",\"docs_browser_cookie.md\":\"8cbcb41a\",\"docs_browser_rendering.md\":\"8f638c6b\",\"docs_javascript_anti-shaking-and-throttling.md\":\"9af40163\",\"docs_javascript_bind.md\":\"0e4d9cea\",\"docs_javascript_closure.md\":\"9c603236\",\"docs_javascript_es6-Iterator.md\":\"942ac03c\",\"docs_javascript_es6-Promise.md\":\"56c7c057\",\"docs_javascript_es6-module.md\":\"0b7596e3\",\"docs_javascript_event-loop.md\":\"9969f462\",\"docs_javascript_inherit.md\":\"7889c76a\",\"docs_javascript_scope.md\":\"15bb219e\",\"docs_node_realize-require.md\":\"3830c2f9\",\"docs_vue_interview.md\":\"005b29bf\",\"docs_vue_vue-array-update.md\":\"041757dc\",\"docs_vue_vue-bind.md\":\"6fc818cf\",\"docs_vue_book_srqc-1.md\":\"e66ab639\",\"docs_vue_book_srqc-10.md\":\"b56c32c7\",\"docs_vue_book_srqc-2.md\":\"4e783021\",\"docs_vue_book_srqc-3.md\":\"028c7b9d\",\"docs_vue_book_srqc-4.md\":\"74007c18\",\"docs_vue_book_srqc-5.md\":\"d3152f32\",\"docs_vue_book_srqc-6.md\":\"f53289b5\",\"docs_vue_book_srqc-7.md\":\"b6d0a962\",\"docs_vue_book_srqc-8.md\":\"95cb9979\",\"docs_vue_book_srqc-9.md\":\"2a093e51\"}")</script>
    <script type="module" async src="/nirvana/_assets/app.963d3ba1.js"></script>
  </body>
</html>